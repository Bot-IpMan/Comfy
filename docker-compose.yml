services:
  comfyui:
    build:
      context: .
      dockerfile: Dockerfile
    image: ${COMFYUI_IMAGE:-comfyui:local}
    container_name: comfyui
    restart: unless-stopped

    # дає Docker'у GPU у звичайному (не swarm) compose
    device_requests:
      - driver: nvidia
        count: 1
        capabilities: ["gpu"]

    environment:
      # видимість та можливості NVIDIA
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
      CUDA_DEVICE_ORDER: "PCI_BUS_ID"
      CUDA_VISIBLE_DEVICES: "0"

      # критично для LXC: nvidia-container-runtime без cgroups
      # (ти вже маєш no-cgroups=true в /etc/nvidia-container-runtime/config.toml) 
      # джерело: обхід для LXC/LXD :contentReference[oaicite:8]{index=8}

      # ↓ усе з Dockerfile продубльовано, щоб було видно й тут:
      GLIBC_TUNABLES: "glibc.cpu.hwcaps=-AVX_Usable,-AVX2_Usable,-AVX_Fast_Unaligned_Load,-ERMS"
      ONEDNN_MAX_CPU_ISA: "SSE41"
      ATEN_CPU_CAPABILITY: "default"
      ATEN_DISABLE_CPU_CAPABILITY: "avx,avx2,avx512,avx512_vnni,fma4"
      OMP_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      OPENBLAS_NUM_THREADS: "1"
      NUMEXPR_NUM_THREADS: "1"
      PYTORCH_CUDA_ALLOC_CONF: "backend:native,max_split_size_mb:128"
      XFORMERS_DISABLED: "1"
      PYTHONNOUSERSITE: "1"

      # Прапори запуску ComfyUI — мінімальний тиск на VRAM/CPU
      CLI_ARGS: >-
        --listen --port 8188
        --lowvram --disable-smart-memory
        --preview-method none
        --fp32-text-enc
        --disable-cuda-malloc
        --disable-all-custom-nodes

    # важливо: без зайвих пробілів/слешів, щоб не зламати argparse
    command: ["/usr/local/bin/docker-entrypoint.sh"]

    # зручні мапінги
    volumes:
      - ./comfyui/models:/opt/ComfyUI/models
      - ./comfyui/input:/opt/ComfyUI/input
      - ./comfyui/output:/opt/ComfyUI/output
      - ./comfyui/custom_nodes:/opt/ComfyUI/custom_nodes
      - ./comfyui/user:/opt/ComfyUI/user

    ports:
      - "8188:8188"

    # стабільність
    shm_size: "2gb"
    ulimits:
      memlock: -1
      stack: 268435456
      nofile:
        soft: 65536
        hard: 65536

    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8188/ > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
