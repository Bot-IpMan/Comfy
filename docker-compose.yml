name: comfy

x-common-env: &common-env
  NVIDIA_VISIBLE_DEVICES: "all"
  NVIDIA_DRIVER_CAPABILITIES: "compute,utility"
  CUDA_DEVICE_ORDER: "PCI_BUS_ID"
  CUDA_VISIBLE_DEVICES: "0"

  # Pascal: примусово рідний аллокатор PyTorch (у 2.3.x валідні: native|cudaMallocAsync)
  PYTORCH_CUDA_ALLOC_CONF: "backend:native,max_split_size_mb:128"

  # Старий CPU без AVX → відрізаємо «важкі» ISA, щоб уникнути крашів у CPU-путі
  ATEN_CPU_CAPABILITY: "default"
  ATEN_DISABLE_CPU_CAPABILITY: "avx,avx2,avx512,avx512_vnni,fma4"
  ONEDNN_MAX_CPU_ISA: "SSE41"
  GLIBC_TUNABLES: "glibc.cpu.hwcaps=-AVX2_Usable,-AVX_Usable,-AVX_Fast_Unaligned_Load,-ERMS"

  # Менше гонок у BLAS
  OMP_NUM_THREADS: "1"
  MKL_NUM_THREADS: "1"
  OPENBLAS_NUM_THREADS: "1"
  NUMEXPR_NUM_THREADS: "1"

  XFORMERS_DISABLED: "1"
  MALLOC_ARENA_MAX: "2"

  # ВАЖЛИВО: один суцільний рядок без бекслешів
  # Усе на GPU, FP16 на UNet/VAE/CLIP, без кастом-нодів, без прев’ю, mmap ваг
  CLI_ARGS: "--listen --port 8188 --gpu-only --fp16-text-enc --fp16-vae --fp16-unet --disable-smart-memory --disable-all-custom-nodes --preview-method none --mmap-torch-files --reserve-vram 256"

x-common-svc: &common-svc
  image: ${COMFYUI_IMAGE:-comfyui:local}
  build:
    context: .
    dockerfile: Dockerfile
    args:
      TORCH_INDEX_URL: ${TORCH_INDEX_URL:-https://download.pytorch.org/whl/cu121}
  command: ["/usr/local/bin/docker-entrypoint.sh"]
  environment: *common-env
  volumes:
    - ./comfyui/models:/opt/ComfyUI/src/models
    - ./comfyui/input:/opt/ComfyUI/input
    - ./comfyui/output:/opt/ComfyUI/output
    - ./comfyui/custom_nodes:/opt/ComfyUI/custom_nodes
    - ./comfyui/user:/opt/ComfyUI/user
  deploy:
    resources:
      reservations:
        devices:
          - driver: nvidia
            count: 1
            capabilities: [gpu]
  shm_size: "2gb"
  ulimits:
    memlock: -1
    stack: 268435456
    nofile:
      soft: 65536
      hard: 65536
  healthcheck:
    test: ["CMD-SHELL", "curl -fsS http://localhost:8188/ > /dev/null || exit 1"]
    interval: 30s
    timeout: 10s
    retries: 5
    start_period: 90s

services:
  comfyui:
    <<: *common-svc
    container_name: comfyui
    restart: unless-stopped
    privileged: true
    security_opt:
      - seccomp=unconfined
    cap_add:
      - IPC_LOCK
      - SYS_NICE
    ports:
      - "8188:8188"

  comfyui-debug:
    <<: *common-svc
    container_name: comfyui-debug
    profiles: ["debug"]
    restart: "no"        # не перезапускаємо — зручно ловити стек/логи
    privileged: true
    security_opt:
      - seccomp=unconfined
    cap_add:
      - SYS_PTRACE
      - IPC_LOCK
      - SYS_NICE
    environment:
      <<: *common-env
      PYTHONFAULTHANDLER: "1"
      TORCH_SHOW_CPP_STACKTRACES: "1"
      TORCH_CPP_LOG_LEVEL: "INFO"
      CUDA_LAUNCH_BLOCKING: "1"
      LIBC_FATAL_STDERR_: "1"
      # докладні логи ComfyUI
      CLI_ARGS: "--listen --port 8188 --gpu-only --fp16-text-enc --fp16-vae --fp16-unet --disable-smart-memory --disable-all-custom-nodes --preview-method none --mmap-torch-files --reserve-vram 256 --verbose DEBUG --log-stdout"
    ports:
      - "8189:8188"
